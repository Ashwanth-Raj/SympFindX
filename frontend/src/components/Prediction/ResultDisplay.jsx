import React, { useState } from 'react';
import { Link } from 'react-router-dom';
import {
Brain,
Eye,
Download,
Share2,
Calendar,
User,
CheckCircle,
AlertTriangle,
Clock,
BarChart3,
FileText,
Phone,
RefreshCw
} from 'lucide-react';
import { usePrediction } from '../../context/PredictionContext';
import { getUrgencyLevel, getConfidenceLevel, formatDate } from '../../utils/helpers';
import { ROUTES } from '../../utils/constants';

// Normalize "Diabetic_Retinopathy" -> "Diabetic Retinopathy"
function normalizeDisease(label) {
if (!label) return 'Unknown';
const pretty = String(label).replace(/_/g, ' ').trim();
return pretty.charAt(0).toUpperCase() + pretty.slice(1);
}

// Schema uses "moderate" but UI helper might expect "medium"
function normalizeUrgency(u) {
if (!u) return 'low';
const val = String(u).toLowerCase();
return val === 'moderate' ? 'medium' : val; // low | medium | high | emergency
}

const ResultDisplay = () => {
const { currentPrediction, resetPrediction, addPredictionToHistory } = usePrediction();
const [showFullReport, setShowFullReport] = useState(false);

// Always compute derived values safely (no conditional hooks)
const disease = normalizeDisease(currentPrediction?.disease);
const confidencePct = Number.isFinite(currentPrediction?.confidence)
? currentPrediction.confidence
: Math.round(((currentPrediction?.confidence || 0)) * 100);
const urgencyKey = normalizeUrgency(currentPrediction?.urgency || 'low');

// Compute top predictions without useMemo to avoid conditional-hook lint
const topPreds = (() => {
const rawTop = currentPrediction?.raw?.top_predictions || currentPrediction?.top_predictions || [];
return Array.isArray(rawTop) ? rawTop.slice(0, 3) : [];
})();

if (!currentPrediction) {
return (
<div className="card text-center py-12">
<AlertTriangle className="w-16 h-16 text-yellow-400 mx-auto mb-4" />
<h3 className="text-xl font-semibold text-white mb-2">No Results Available</h3>
<p className="text-navy-400 mb-6">Please complete the image upload and symptom analysis first.</p>
<button onClick={resetPrediction} className="btn-primary">
Start New Analysis
</button>
</div>
);
}

const urgency = getUrgencyLevel(urgencyKey);
const confidence = getConfidenceLevel(confidencePct);

const handleSaveReport = () => {
addPredictionToHistory(currentPrediction);
alert('Report saved to your medical history!');
};

const reportData = `
SympFindX - Eye Analysis Report
Generated: ${formatDate(currentPrediction.createdAt)}

DIAGNOSIS:
Disease: ${currentPrediction.disease || 'N/A'}
Confidence: ${confidencePct}%
Priority: ${urgency.label}

DESCRIPTION:
${currentPrediction.description || 'N/A'}

RECOMMENDATIONS:
${(currentPrediction.recommendations || [])
  .map((rec, i) => `${i + 1}. ${rec}`)
  .join('\n')}

SYMPTOMS:
${currentPrediction.symptoms || 'N/A'}

This report is generated by AI and should be reviewed by a medical professional.
`;


const handleDownloadReport = () => {
const blob = new Blob([reportData], { type: 'text/plain' });
const url = window.URL.createObjectURL(blob);
const link = document.createElement('a');
link.href = url;
link.download = `SympFindX_Report_${currentPrediction.id}.txt`;

document.body.appendChild(link);
link.click();
document.body.removeChild(link);
window.URL.revokeObjectURL(url);
};

const diseaseInfoMap = {
'Normal': {
icon: CheckCircle, color: 'text-green-400', bgColor: 'bg-green-400/10',
message: 'Great news! No eye diseases detected.',
nextSteps: 'Continue with regular eye checkups and maintain healthy habits.'
},
'Diabetic Retinopathy': {
icon: AlertTriangle, color: 'text-red-400', bgColor: 'bg-red-400/10',
message: 'Diabetic retinopathy detected. Immediate attention recommended.',
nextSteps: 'Schedule consultation with a retina specialist as soon as possible.'
},
'Glaucoma': {
icon: Clock, color: 'text-orange-400', bgColor: 'bg-orange-400/10',
message: 'Signs of glaucoma detected. Early treatment is crucial.',
nextSteps: 'Consult with an ophthalmologist for pressure testing and treatment options.'
},
'Macular Degeneration': {
icon: Eye, color: 'text-yellow-400', bgColor: 'bg-yellow-400/10',
message: 'Macular degeneration signs detected. Regular monitoring needed.',
nextSteps: 'See a retina specialist for detailed examination and treatment planning.'
},
'Dry Eye': {
icon: Eye, color: 'text-blue-400', bgColor: 'bg-blue-400/10',
message: 'Dry eye indications detected.',
nextSteps: 'Use lubricating eye drops and consult if symptoms persist.'
},
'Conjunctivitis': {
icon: Eye, color: 'text-pink-400', bgColor: 'bg-pink-400/10',
message: 'Conjunctivitis (pink eye) signs detected.',
nextSteps: 'Maintain hygiene, avoid touching eyes; consult if needed.'
},
'Pterygium': {
icon: Eye, color: 'text-cyan-400', bgColor: 'bg-cyan-400/10',
message: 'Pterygium signs detected.',
nextSteps: 'Consider UV protection; consult an ophthalmologist if irritation persists.'
},
'Cataract': {
icon: Eye, color: 'text-indigo-400', bgColor: 'bg-indigo-400/10',
message: 'Cataract signs detected.',
nextSteps: 'Consult for evaluation; surgery may be considered if vision is affected.'
}
};

const diseaseInfo = diseaseInfoMap[disease] || diseaseInfoMap['Normal'];
const IconComponent = diseaseInfo.icon;

return (
<div className="space-y-8">
{/* Main Result Card */}
<div className="card">
<div className="text-center mb-8">
<Brain className="w-16 h-16 text-primary-500 mx-auto mb-4" />
<h2 className="text-3xl font-bold text-white mb-2 font-roboto-slab">Analysis Complete</h2>
<p className="text-navy-300">Your AI-powered eye health analysis results</p>
</div>

    {/* Main Diagnosis */}
    <div className={`${diseaseInfo.bgColor} rounded-xl p-8 mb-8 text-center`}>
      <IconComponent className={`w-20 h-20 ${diseaseInfo.color} mx-auto mb-4`} />
      <h3 className="text-2xl font-bold text-white mb-2">{disease}</h3>
      <p className={`text-lg ${diseaseInfo.color} mb-4`}>{diseaseInfo.message}</p>
      <p className="text-navy-300">{diseaseInfo.nextSteps}</p>
    </div>

    {/* Analysis Metrics */}
    <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
      <div className="text-center p-6 bg-navy-800/30 rounded-lg">
        <BarChart3 className="w-8 h-8 text-primary-500 mx-auto mb-3" />
        <h4 className="text-lg font-semibold text-white mb-1">AI Confidence</h4>
        <p className={`text-2xl font-bold ${confidence.color}`}>{confidencePct}%</p>
        <p className="text-navy-400 text-sm">{confidence.level}</p>
      </div>

      <div className="text-center p-6 bg-navy-800/30 rounded-lg">
        <Clock className={`w-8 h-8 ${urgency.color} mx-auto mb-3`} />
        <h4 className="text-lg font-semibold text-white mb-1">Priority Level</h4>
        <p className={`text-2xl font-bold ${urgency.color}`}>{urgency.label}</p>
        <p className="text-navy-400 text-sm">Follow-up timeline</p>
      </div>

      <div className="text-center p-6 bg-navy-800/30 rounded-lg">
        <Calendar className="w-8 h-8 text-blue-400 mx-auto mb-3" />
        <h4 className="text-lg font-semibold text-white mb-1">Analysis Date</h4>
        <p className="text-2xl font-bold text-blue-400">
          {formatDate(currentPrediction.createdAt).split(',')[0]}
        </p>
        <p className="text-navy-400 text-sm">
          {formatDate(currentPrediction.createdAt).split(' at ')[1]}
        </p>
      </div>
    </div>

    {/* Top predictions (optional) */}
    {topPreds.length > 0 && (
      <div className="mb-8 p-6 bg-navy-800/30 rounded-lg">
        <h4 className="text-lg font-semibold text-white mb-3">Top predictions</h4>
        <ul className="list-disc list-inside text-navy-300">
          {topPreds.map((t, idx) => (
            <li key={`${t.label}-${idx}`}>
              {normalizeDisease(t.label)} â€” {(t.confidence * 100).toFixed(1)}%
            </li>
          ))}
        </ul>
      </div>
    )}

    {/* Description */}
    <div className="mb-8 p-6 bg-navy-800/30 rounded-lg">
      <h4 className="text-lg font-semibold text-white mb-3">Analysis Description</h4>
      <p className="text-navy-300 leading-relaxed">
        {currentPrediction.description || 'N/A'}
      </p>
    </div>

    {/* Toggle Full Report */}
    <div className="mb-8 text-center">
      <button onClick={() => setShowFullReport(!showFullReport)} className="btn-secondary">
        {showFullReport ? 'Hide Full Report' : 'Show Full Report'}
      </button>
      {showFullReport && (
        <pre className="mt-4 p-4 bg-navy-800/30 rounded-lg text-left text-sm text-navy-300 whitespace-pre-wrap">
          {reportData}
        </pre>
      )}
    </div>
  </div>

  {/* Recommendations */}
  <div className="card">
    <h3 className="text-2xl font-bold text-white mb-6 font-roboto-slab">Recommendations</h3>
    <div className="space-y-4">
      {(currentPrediction.recommendations || []).map((recommendation, index) => (
        <div key={index} className="flex items-start space-x-4 p-4 bg-navy-800/30 rounded-lg">
          <div className="w-8 h-8 bg-primary-600/20 rounded-full flex items-center justify-center flex-shrink-0">
            <span className="text-primary-400 font-semibold text-sm">{index + 1}</span>
          </div>
          <p className="text-navy-300 leading-relaxed">{recommendation}</p>
        </div>
      ))}
    </div>
  </div>

  {/* Specialist Recommendation */}
  {disease !== 'Normal' && (
    <div className="card">
      <h3 className="text-2xl font-bold text-white mb-6 font-roboto-slab">Recommended Specialist</h3>
      <div className="flex items-center space-x-6 p-6 bg-navy-800/30 rounded-lg">
        <div className="w-16 h-16 bg-gradient-to-br from-primary-500 to-primary-700 rounded-full flex items-center justify-center">
          <User className="w-8 h-8 text-white" />
        </div>
        <div className="flex-1">
          <h4 className="text-lg font-semibold text-white mb-1">
            {disease.includes('Diabetic Retinopathy') ? 'Dr. Sarah Johnson' :
             disease.includes('Glaucoma') ? 'Dr. Michael Chen' :
             'Dr. Priya Sharma'}
          </h4>
          <p className="text-primary-400 mb-2">
            {disease.includes('Diabetic Retinopathy') ? 'Retina Specialist' :
             disease.includes('Glaucoma') ? 'Glaucoma Specialist' :
             'Ophthalmologist'}
          </p>
          <div className="flex items-center space-x-4 text-sm text-navy-400">
            <div className="flex items-center space-x-1">
              <Phone className="w-4 h-4" />
              <span>+91 987 654 3210</span>
            </div>
            <div className="flex items-center space-x-1">
              <Calendar className="w-4 h-4" />
              <span>Available for consultation</span>
            </div>
          </div>
        </div>
        <button className="btn-primary flex items-center">
          <Phone className="w-4 h-4 mr-2" />
          Contact Specialist
        </button>
      </div>
    </div>
  )}

  {/* Action Buttons */}
  <div className="card">
    <h3 className="text-xl font-bold text-white mb-6">Next Steps</h3>
    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
      <button onClick={handleSaveReport} className="btn-secondary flex items-center justify-center">
        <FileText className="w-5 h-5 mr-2" />
        Save Report
      </button>

      <button onClick={handleDownloadReport} className="btn-secondary flex items-center justify-center">
        <Download className="w-5 h-5 mr-2" />
        Download PDF
      </button>

      <button className="btn-secondary flex items-center justify-center">
        <Share2 className="w-5 h-5 mr-2" />
        Share Results
      </button>

      <Link to={ROUTES.REPORTS} className="btn-secondary flex items-center justify-center">
        <Eye className="w-5 h-5 mr-2" />
        View History
      </Link>
    </div>
  </div>

  {/* Start New Analysis */}
  <div className="card text-center">
    <h3 className="text-xl font-bold text-white mb-4">Need Another Analysis?</h3>
    <p className="text-navy-300 mb-6">
      Start a new eye health screening or track changes over time
    </p>
    <div className="flex flex-col sm:flex-row justify-center space-y-4 sm:space-y-0 sm:space-x-4">
      <button onClick={resetPrediction} className="btn-primary flex items-center justify-center">
        <RefreshCw className="w-5 h-5 mr-2" />
        New Analysis
      </button>
      <Link to={ROUTES.DASHBOARD} className="btn-secondary flex items-center justify-center">
        Back to Dashboard
      </Link>
    </div>
  </div>

  {/* Medical Disclaimer */}
  <div className="card bg-yellow-400/10 border-yellow-400/30">
    <div className="flex items-start space-x-3">
      <AlertTriangle className="w-6 h-6 text-yellow-400 mt-1 flex-shrink-0" />
      <div>
        <h4 className="text-yellow-400 font-semibold mb-2">Medical Disclaimer</h4>
        <p className="text-yellow-300 text-sm leading-relaxed">
          This AI analysis is for screening and educational purposes only. It should not be used as a
          substitute for professional medical diagnosis, advice, or treatment. Always consult with
          qualified healthcare professionals for medical concerns and before making any healthcare decisions.
        </p>
      </div>
    </div>
  </div>
</div>
);
};

export default ResultDisplay;